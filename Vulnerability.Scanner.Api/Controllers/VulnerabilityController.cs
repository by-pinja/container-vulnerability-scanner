using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Hangfire;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Options;
using Newtonsoft.Json.Linq;
using Vulnerability.Scanner.Api.Controllers.Domain;
using Vulnerability.Scanner.Api.Controllers.Models;
using Vulnerability.Scanner.Api.Data;
using Vulnerability.Scanner.Api.Options;
using Vulnerability.Scanner.Api.Shell;
using Vulnerability.Scanner.Api.Util;
using Vulnerability.Scanner.Clair;

namespace Vulnerability.Scanner.Api.Controllers
{
    public class VulnerabilityController : Controller
    {
        private readonly IOptionsSnapshot<GeneralOptions> _generalConfig;
        private readonly ScannerDataContext _dataContext;
        private readonly Reports reportActions;

        public VulnerabilityController(
            IOptionsSnapshot<GeneralOptions> generalConfig,
            ScannerDataContext dataContext,
            Reports reportActions)
        {
            _generalConfig = generalConfig;
            _dataContext = dataContext;
            this.reportActions = reportActions;
        }

        [HttpPost("v1/scan/")]
        [Authorize(AuthenticationSchemes = "ApiKey")]
        public ActionResult<VulnerabilityScanResponse> Post([FromBody] VulnerabilityScanRequest value)
        {
            return Ok(reportActions.CreateReport(value));
        }

        [HttpGet("/v1/reports/{id}")]
        public ActionResult<object> GetReport(Guid id)
        {
            var report = reportActions.GetReportOrDefault(id);

            if (report == null)
                return NotFound();

            if (!report.Processed)
                return NotFound(new { Status = "Processing" });

            return Ok(report.Vurnelabilities);
        }

        [HttpGet("/v1/reports/{id}/html")]
        public IActionResult GetReportAsHtml(Guid id)
        {
            var report = reportActions.GetReportOrDefault(id);

            if (report == null)
                return NotFound();

            if (!report.Processed)
                return NotFound("Processing");

            return View("~/Controllers/Pages/Report.cshtml", report);
        }
    }
}
