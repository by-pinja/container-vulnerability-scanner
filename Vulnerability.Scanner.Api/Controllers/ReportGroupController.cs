using System;
using System.Collections.Generic;
using System.Linq;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Options;
using Vulnerability.Scanner.Api.Controllers.Domain;
using Vulnerability.Scanner.Api.Controllers.Models;
using Vulnerability.Scanner.Api.Data;
using Vulnerability.Scanner.Api.Model;

namespace Vulnerability.Scanner.Api.Controllers
{
    public class ReportGroupController : Controller
    {
        private readonly Reports reports;
        private readonly IOptionsSnapshot<GeneralOptions> config;

        public ReportGroupController(Reports reports, ScannerDataContext context, IOptionsSnapshot<GeneralOptions> config)
        {
            this.reports = reports;
            this.config = config;
        }

        [HttpPut("v1/group/{groupId}")]
        public ActionResult<GroupScanResponse> Put(string groupId, [FromBody] GroupScanRequest value)
        {
            if (string.IsNullOrEmpty(groupId))
                return BadRequest();

            var group = this.reports.PutGroup(groupId, value);
            return new GroupScanResponse(group, this.config);
        }

        [HttpGet("v1/group/{groupId}")]
        public ActionResult<GroupScanResponse> GetGroupReport(string groupId)
        {
            var group = this.reports.GetGroupOrDefault(groupId);

            if(group == null)
                return NotFound();

            return new GroupScanResponse(group, this.config);
        }

        [HttpGet("v1/group/{groupId}/html")]
        public IActionResult GetGroupReportHtml(string groupId)
        {
            var group = this.reports.GetGroupOrDefault(groupId);

            if(group == null)
                return NotFound();

            return View("~/Controllers/Pages/GroupReport.cshtml", group);
        }

        [HttpGet("v1/group")]
        public ActionResult<GroupSummaryModel> GetAll()
        {
            return Ok(this.reports.GetGroupSummary());
        }

        [HttpGet("v1/group/html")]
        public IActionResult GetAllHtml()
        {
            return View("~/Controllers/Pages/GroupSummary.cshtml", this.reports.GetGroupSummary());
        }

        [HttpGet("v1/cve-group/")]
        public ActionResult<CveSummaryModel> GetAllCve(string sortOrder)
        {
            return Ok(this.reports.GetCveSummary());
        }

        [HttpGet("v1/cve-group/html")]
        public IActionResult GetAllCveHtml()
        {
            List<CveSummaryModel> cves = new List<CveSummaryModel>();
            cves.Add(new CveSummaryModel() { Severity="High", Name="Testi CVE1", Description="skjadhlkshad", Frequency=3 });
            cves.Add(new CveSummaryModel() { Severity="High", Name="Testi CVE2", Description="skjadhlkshad", Frequency=3 });
            cves.Add(new CveSummaryModel() { Severity="Medium", Name="Testi CVE3", Description="skjadhlkshad", Frequency=3 });
            cves.Add(new CveSummaryModel() { Severity="Low", Name="Testi CVE4", Description="skjadhlkshad", Frequency=3 });

            return View("~/Controllers/Pages/CVEGroupSummary.cshtml", cves);
        }

        [HttpGet("v1/cve-group/")]
        public ActionResult<GroupSummaryModel> GetCveSummary()
        {
            return Ok(this.reports.GetCveSummary());
        }

        [HttpGet("v1/cve-group/{name}/html")]
        public IActionResult GetCveSummaryHtml(string name)
        {
            return View("~/Controllers/Pages/CVESummary.cshtml");
        }
    }
}