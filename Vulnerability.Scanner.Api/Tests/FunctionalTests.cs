using System;
using System.Linq;
using System.Net;
using System.Threading;
using FluentAssertions;
using Newtonsoft.Json.Linq;
using Protacon.NetCore.WebApi.TestUtil;
using Protacon.NetCore.WebApi.TestUtil.Extensions;
using Vulnerability.Scanner.Api.Controllers.Models;
using Vulnerability.Scanner.Api.Data;
using Vulnerability.Scanner.Api.Depencies;
using Vulnerability.Scanner.Api.Tests;
using Xunit;

namespace Vulnerability.Scanner.Api
{
    public class FunctionalTests
    {
        [Fact]
        public void WhenPdfIsSent_ThenPdfShouldBeSoonAvailable()
        {
            var host = TestHost.Run<TestStartup>();

            var result = host
                .Post("/v1/scan/", new VulnerabilityScanRequest {
                    Image = "testimage:latest"
                })
                .ExpectStatusCode(HttpStatusCode.OK)
                .WithContentOf<VulnerabilityScanResponse>()
                .Select();

            host.Get(result.ResultsUri)
                .WaitForStatusCode(HttpStatusCode.OK, timeout: TimeSpan.FromSeconds(10))
                .WithContentOf<VurnelabilityModel[]>()
                .Passing(x => x.Single().Severity.Should().Be(Severity.High));

            host.Get(result.HtmlResultsUri)
                .WaitForStatusCode(HttpStatusCode.OK, timeout: TimeSpan.FromSeconds(10))
                .WithContentOf<string>()
                .Passing(x => x.Should().Contain("High"));
        }

        [Fact]
        public void WhenInvalidReportIdIsFetched_ThenReturnNotFound()
        {
            var host = TestHost.Run<TestStartup>();

            host.Get($"/v1/reports/{Guid.NewGuid()}")
                .ExpectStatusCode(HttpStatusCode.NotFound);

            host.Get($"/v1/reports/{Guid.NewGuid()}/html")
                .ExpectStatusCode(HttpStatusCode.NotFound);
        }
    }
}