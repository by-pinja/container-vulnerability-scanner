using System;
using System.Collections.Generic;
using System.Linq;
using System.Net;
using FluentAssertions;
using Microsoft.AspNetCore.TestHost;
using NUnit.Framework;
using Protacon.NetCore.WebApi.TestUtil;
using Protacon.NetCore.WebApi.TestUtil.Extensions;
using Vulnerability.Scanner.Api.Model;
using Vulnerability.Scanner.Api.Controllers.Models;
using System.Threading.Tasks;

namespace Vulnerability.Scanner.Api.Tests
{
    [TestFixture]
    public class CVETests
    {
        private static Task<GroupScanResponse> PutGroup(TestServer host, Guid groupId, IEnumerable<VulnerabilityScanRequest> scanRequests)
        {
            return host
                .Put($"/v1/group/{groupId}", new GroupScanRequest
                {
                    ScanRequests = scanRequests
                })
                .ExpectStatusCode(HttpStatusCode.OK)
                .WithContentOf<GroupScanResponse>()
                .Select();
        }

        [Test]
        public async Task WhenInvalidCVEIdIsFetched_ThenReturnNotFound()
        {
            var host = SharedSetupFixture.Host;

            await host.Get($"/v1/cve/{Guid.NewGuid()}/")
                .ExpectStatusCode(HttpStatusCode.NotFound);

            await host.Get($"/v1/cve/{Guid.NewGuid()}/html")
                .ExpectStatusCode(HttpStatusCode.NotFound);
        }

        [Test]
        public async Task WhenGroupIsAdded_ThenCVESummaryShouldBeAvailable()
        {
            var host = SharedSetupFixture.Host;
            var groupId = Guid.NewGuid();

            var response = await PutGroup(host, groupId, new [] { new VulnerabilityScanRequest("node:latest") });

            await host.Get(response.ResultsUri)
                .WaitForStatusCode(HttpStatusCode.OK, timeout: TimeSpan.FromSeconds(10))
                .WithContentOf<GroupScanResponse>();

            await host.Get($"/v1/cve/")
                .WaitForStatusCode(HttpStatusCode.OK, timeout: TimeSpan.FromSeconds(10))
                .WithContentOf<IEnumerable<CveSummaryModel>>()
                .Passing(x => x.Count().Should().BeGreaterThan(0));
        }

        [Test]
        public async Task WhenGroupIsCreated_ThenCheckCveCode()
        {
            var host = SharedSetupFixture.Host;

            var groupId = Guid.NewGuid();
            var result = await PutGroup(host, groupId, new [] { new VulnerabilityScanRequest("node:latest") });

            await host.Get(result.HtmlResultsUri)
                .WaitForStatusCode(HttpStatusCode.OK, timeout: TimeSpan.FromSeconds(15));

            await host.Get($"/v1/cve/")
                .WaitForStatusCode(HttpStatusCode.OK, timeout: TimeSpan.FromSeconds(10))
                .WithContentOf<IEnumerable<CveSummaryModel>>()
                .Passing(x => x.Should().Contain(a => a.Name == "CVE-2017-16997"));
        }

        [Test]
        public async Task WhenSelectedSortedByName_ThenCVEShouldBeSortedRight()
        {
            var host = SharedSetupFixture.Host;
            var groupId = Guid.NewGuid();

            var response = await PutGroup(host, groupId, new [] { new VulnerabilityScanRequest("node:latest") });

            await host.Get(response.ResultsUri)
                .WaitForStatusCode(HttpStatusCode.OK, timeout: TimeSpan.FromSeconds(10))
                .WithContentOf<GroupScanResponse>();

            await host.Get($"/v1/cve/?sortedBy=name")
                .WaitForStatusCode(HttpStatusCode.OK, timeout: TimeSpan.FromSeconds(10))
                .WithContentOf<IEnumerable<CveSummaryModel>>()
                .Passing(x => Assert.IsTrue(x.SequenceEqual(x.OrderByDescending(a => a.Name))));

            await host.Get($"/v1/cve/?sortedBy=nameDesc")
                .WaitForStatusCode(HttpStatusCode.OK, timeout: TimeSpan.FromSeconds(10))
                .WithContentOf<IEnumerable<CveSummaryModel>>()
                .Passing(x => Assert.IsTrue(x.SequenceEqual(x.OrderBy(a => a.Name))));
        }

        [Test]
        public async Task WhenSelectedSortedByFrequency_ThenCVEShouldBeSortedRight()
        {
            var host = SharedSetupFixture.Host;
            var groupId = Guid.NewGuid();

            var response = await PutGroup(host, groupId, new [] { new VulnerabilityScanRequest("node:latest") });

            await host.Get(response.ResultsUri)
                .WaitForStatusCode(HttpStatusCode.OK, timeout: TimeSpan.FromSeconds(10))
                .WithContentOf<GroupScanResponse>();

            await host.Get($"/v1/cve/?sortedBy=frequency")
                .WaitForStatusCode(HttpStatusCode.OK, timeout: TimeSpan.FromSeconds(10))
                .WithContentOf<IEnumerable<CveSummaryModel>>()
                .Passing(x => Assert.IsTrue(x.SequenceEqual(x.OrderByDescending(a => a.Frequency))));

            await host.Get($"/v1/cve/?sortedBy=frequencyDesc")
                .WaitForStatusCode(HttpStatusCode.OK, timeout: TimeSpan.FromSeconds(10))
                .WithContentOf<IEnumerable<CveSummaryModel>>()
                .Passing(x => Assert.IsTrue(x.SequenceEqual(x.OrderBy(a => a.Frequency))));
        }

        [Test]
        public async Task WhenSortedByInvalidValue_ThenCVEShouldBeSortedByDefault()
        {
            var host = SharedSetupFixture.Host;
            var groupId = Guid.NewGuid();

            var response = await PutGroup(host, groupId, new [] { new VulnerabilityScanRequest("node:latest") });

            await host.Get(response.ResultsUri)
                .WaitForStatusCode(HttpStatusCode.OK, timeout: TimeSpan.FromSeconds(10))
                .WithContentOf<GroupScanResponse>();

            await host.Get($"/v1/cve/?sortedBy=asdf")
                .WaitForStatusCode(HttpStatusCode.OK, timeout: TimeSpan.FromSeconds(10))
                .WithContentOf<IEnumerable<CveSummaryModel>>();
        }
    }
}