using System;
using System.Diagnostics;
using Microsoft.Extensions.Options;

namespace Vulnerability.Scanner.Api.Shell
{
    public class CommandLineWindows : ICommandLine
    {
        private const int _timeoutSec = 60;

        public string Run(string command)
        {
            if(command == null)
                throw new ArgumentNullException(nameof(command));

            var psi = new ProcessStartInfo
            {
                FileName = "cmd.exe",
                Arguments = $"/C {command}",
                UseShellExecute = false,
                RedirectStandardOutput = true,
                RedirectStandardError = true
            };

            var proc = new Process
            {
                StartInfo = psi
            };

            proc.Start();
            proc.WaitForExit(_timeoutSec * 1000);

            if (!proc.HasExited)
            {
                throw new InvalidOperationException($"Command '{command}' failed to exit during timeout, likely command hangs.");
            }

            var error = proc.StandardError.ReadToEnd();

            if (!string.IsNullOrEmpty(error))
                throw new InvalidOperationException($"Failed to run commandline command, error: '{error}'");

            var output = proc.StandardOutput.ReadToEnd();

            return output;
        }
    }
}
