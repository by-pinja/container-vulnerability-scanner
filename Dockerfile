FROM microsoft/dotnet:2.2-sdk-alpine as dotnetBuild

COPY ./README.md /app/
COPY ./Vulnerability.Scanner.Api/ /app/api/
WORKDIR /app/api/

RUN dotnet publish -c release -o /out/

FROM microsoft/dotnet:2.2-aspnetcore-runtime-alpine

COPY --from=dotnetBuild /out/ /app/

ENV KLAR_VER=2.3.0

ADD https://github.com/optiopay/klar/releases/download/v${KLAR_VER}/klar-${KLAR_VER}-linux-amd64 /usr/bin/klar

RUN apk add --update ca-certificates \
    && chmod +x /usr/bin/klar

ENV CLAIR_ADDR http://clair:6060
ENV JSON_OUTPUT=true

ENV ASPNETCORE_ENVIRONMENT=docker

EXPOSE 80

WORKDIR /app/

ENTRYPOINT ["dotnet", "Vulnerability.Scanner.Api.dll"]